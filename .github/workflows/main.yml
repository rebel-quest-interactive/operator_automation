name: operator_automation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  newman_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Newman & HTML reporter
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run Postman collection and generate HTML report
        run: |
          newman run mock_operator.postman_collection.json \
            -e mock_operator.postman_environment.json \
            -r cli,htmlextra \
            --reporter-htmlextra-export newman-report.html

      - name: Parse test results
        id: resultados
        run: |
          if [ -f newman-report.html ]; then
            TOTAL=$(grep -oP 'Total Assertions[\s\S]*?<td>\K\d+' newman-report.html | head -1 || echo 0)
            FAILED=$(grep -oP 'Failed Assertions[\s\S]*?<td>\K\d+' newman-report.html | head -1 || echo 0)
            SUCCESS=$((TOTAL - FAILED))
          else
            TOTAL=0
            SUCCESS=0
            FAILED=0
          fi
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Subir artefacto HTML
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman-report.html

      - name: Enviar notificaci√≥n a Slack
        shell: bash
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TOTAL: ${{ steps.resultados.outputs.total }}
          SUCCESS: ${{ steps.resultados.outputs.success }}
          FAILED: ${{ steps.resultados.outputs.failed }}
          ARTIFACTS_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
        run: |
          PAYLOAD='{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":rocket: *Resultados de pruebas Mock*"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚úÖ √âxito:* '"$SUCCESS"'"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ùå Fallos:* '"$FAILED"'"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üìä Total:* '"$TOTAL"'"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "Ver reporte HTML"
                    },
                    "url": "'"$ARTIFACTS_URL"'"
                  }
                ]
              }
            ]
          }'
          curl -X POST -H 'Content-Type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
